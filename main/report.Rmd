---
title: "Data Visualization"
author: "Cody, Max, Priya, and Mohammed"
output:
  html_document:
    fig_caption: yes
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = F,
                      message = F)
```

# Introduction

Baseball, sometimes referred to as the Great American Pastime, is one of the most popular sports in America. There is an immense amount of baseball data freely available for analysis and is effectively a statistician’s playground. 

We chose the topic of baseball for our final project for a few reasons. One of our group members is involved in fantasy baseball, and we thought that exploring baseball data in-depth would probably help him in future fantasy bracket player selections. We also hoped that this analysis, or a similar analysis, would be potentially applicable to other sports including but not limited to basketball and American football. Lastly we wanted to get insight into a core element of American pop culture, and look into some interesting questions such as steroid use. We had a lot of questions that we thought of, and have listed these below:

Are there any obvious trends between pitching volume and effort in a given year and injuries in the next year?
* How severe are different kinds of injuries to a baseball player’s career?
* Are pitchers who throw different kinds of pitches more susceptible to getting injured? Do certain kinds of pitches lead to different kinds of injuries?
* How do different kinds of injuries affect hitting power?
* How does likelihood of future injury change with different kinds of injuries?
* How did a ball manufacturing change affect number of home runs?
* How may a robot umpire affect the strike zone?

Our group members are:
* Cody Zupnick - data collection, plotting, and report writing
* Mohammad Radiyat - plotting and report writing
* Priya Medberry - 
* Max Mattioli - data quality analysis and report writing

# Description of data: 

The data was collected from a few different sources. Pitcher data was collected from the following [link.](www.fangraphs.com%2Fleaders.aspx%3Fpos%3Dall%26stats%3Dpit%26lg%3Dall%26qual%3Dy%26type%3Dc%252C3%252C31%252C125%252C126%252C127%252C128%252C130%252C131%252C132%252C133%252C135%252C139%252C13%26season%3D2017%26month%3D0%26season1%3D2017%26ind%3D0%26team%3D%26rost%3D%26age%3D%26filter%3D%26players%3D&h=ATM_yMkJmnVUTRMPwJ4QLEVH8tYNAjxgBIYrmH6RqQIzYc_-MeKG_silRZlJQeofqEGo32CC01V4zqagZT4DPi5eIgG67J__srp7yg) The batter data was collected from [here.](www.fangraphs.com%2Fleaders.aspx%3Fpos%3Dall%26stats%3Dbat%26lg%3Dall%26qual%3Dy%26type%3D8%26season%3D2017%26month%3D0%26season1%3D2017%26ind%3D0%26team%3D0%26rost%3D0%26age%3D0%26filter%3D%26players%3D0&h=ATM_yMkJmnVUTRMPwJ4QLEVH8tYNAjxgBIYrmH6RqQIzYc_-MeKG_silRZlJQeofqEGo32CC01V4zqagZT4DPi5eIgG67J__srp7yg)

The injury data was the most difficult to collect. Injury data was obtained via scraping, and the scripts to do so can be found at this Github [link.](https://github.com/Codyz/edavFinalProject/tree/master/scrape)

We can look at a quick summary of the three kinds of raw data files that we'll be using. First we begin with pitch data:
```{r}
library(dplyr)
library(tidyverse)
library(ggplot2)
library(zoo)
pitches_2015 <- read_csv('./data/Pitchers2015.csv')
head(pitches_2015)
```
The first few columns are player name, what team the player is on, player age as of 2015, and total number of pitches in the 2015 season. The next columns (all of which end in %) represent how frequently the player threw a certain kind of pitch. For example, Dalier Hinojosa threw 429 pitches in 2015, 20.20% of which were *FA* (which stands for normal fastballs) and 43.80% of which were *FT* (which stands for two-seam fastballs). The different kinds of pitches and their code are outlined below:
* FA = normal (four-seam) fastball that goes straight and fast
* FT = two-seam fastball, which is similar to a normal fastball but has a little more movement
* FC = cutter, which is designed to shift a little bit when it gets close to home plate (or near where the batter is standing)
* FS = splitter, which breaks down suddenly near home plate
* SI = sinker, which has significant horizintal and downward movement
* SL = slider, which breaks down and away near home plate
* CU = curveball, where the ball has enough forward spin to dive downwards as it reaches home plate. 
* KC = knuckle curve, which is a variant of the curveball that spins less than a normal curveball
* CH = changeup, which is a slow throw that looks like it's a normal fastball; used to throw off the batter's swing timing
The last few columns are *vFA* which is average fastball speed, and *IP* which is number of innings pitched. Note that innings pitched are not integers because pitchers can substitute within innings. 

Next we can look at an example of the injury data:
```{r}
injuries_2016 <- read_csv('./data/injuries_2016.csv')
head(injuries_2016)
```
The data includes the player, their position, kind of injury, and how long that injury lasted in days. Lastly we can look at an example of our raw batter data:
```{r}
df2014 <- read_csv('./data/batters2014.csv')
head(df2014)
```
This data includes player name, team, and several yearly metrics. For more info on these metrics, feel free to read this [documentation](http://www.baseball-almanac.com/stats4.shtml). The important quantity for us is *SLG*, or slugging percentage which is average number of bases a player earns per at-bat. Each time a player bats, he either hits or does not hit; on a hit, a player can get 1, 2, 3, or 4 bases (4 in the case of a home run). *SLG* captures total number of bases earned this way divided by total number of at-bats. 
# Analysis of Data Quality

#Main Analysis

We start by importing the necessary libraries for data processing and plotting:

```{r, cache=T}
# Install all necessary packages
library(dplyr)
library(tidyverse)
library(ggplot2)
library(zoo)
```

**Part 1: Pitching Volume, Effort, and Injuries**

First we look at whether there exist any obvious trends can be seen between pitching volume in a given year and injuries in the following year. Our metrics of volume are seasonal pitch counts, pitches per game, and innings pitched per season. Our basic metric of effort is fastball velocity. All of these are imperfect metrics; a stronger pitcher can throw harder with less effort than a weaker one, for instance, and not all pitches are equally strenuous. But this is a good starting point. 

For now we are not considering age, which we expect to be very important, since older players should get injured more frequently than younger ones. 

We import the data into R objects:
```{r}
pitches_2015 <- read_csv('./data/Pitchers2015.csv')
injuries_2016 <- read_csv('./data/injuries_2016.csv')

pitches_2016 <- read_csv('./data/Pitchers2016.csv')
injuries_2017 <- read_csv('./data/injuries_2017.csv')
```
We combine the injury and pitch data frames together:
```{r}
# join each year before concatting them
joined1 <- merge(injuries_2016, pitches_2015, by.x = "name", by.y = "name", all.y = T)
joined1$year <- '2016'

joined2 <- merge(injuries_2017, pitches_2016, by.x = "name", by.y = "name", all.y = T)
joined2$year <- '2017'

joined <- rbind(joined1, joined2)

joined_pitchers <- filter(joined, pos == "RP" | pos == "SP")
```
Some players are listed with multiple injuries, encoded as Injury1/Injury2/... In those cases the first injury is the most serious, so we will only consider the first listed injury per player for this analysis:
```{r}
extract_injury <- function(val) { strsplit(val, "/")[[1]][[1]] }
```
Lastly we clean up the data, remove missing values and pitchers who never threw a pitch, and consider only injuries that at least ten players suffered. This makes the analysis cleaner, but inherently throws away information about rare injuries which might be valuable at some future point. 
```{r}
# @param df pitch dataframe joined with injury data
clean <- function(df) {
  percent_cols <- colnames(df)[8:16]
  f <- function(val) { sub("%", "", val) }
  df[percent_cols] <- sapply(df[percent_cols], f)
  df[percent_cols] <- sapply(df[percent_cols], as.numeric)
  
  # if a pitcher never throws a pitch
  df[percent_cols][is.na(df[percent_cols])] <- 0
  df$type[is.na(df$type)] <- "None"
  df$days[is.na(df$days)] <- 0

  df$type <- sapply(df$type, extract_injury)
  
  df
}

joined <- clean(joined)
joined_pitchers <- clean(joined_pitchers)
joined_pitchers <- mutate(group_by(joined_pitchers, type), cnt = n())
joined_pitchers <- filter(joined_pitchers, cnt >= 10)
```
Now we plot number of pitches versus injury type and average fastball throw speed versus injury type:
```{r}
ggplot(joined_pitchers, aes(x=type, y=Pitches)) + geom_jitter(color="coral4") + coord_flip() + 
  ylab("Number of Pitches") + xlab("Injury Type") + ggtitle("Injury Type vs Number of Pitches") + 
  theme(plot.title = element_text(hjust = 0.5))

ggplot(joined_pitchers, aes(x=type, y=vFA)) + geom_jitter(color="coral3") + coord_flip() + 
  ylab("Fastball Average Speed") + xlab("Injury Type") + ggtitle("Injury Type vs Fastball Average Speed") + 
  theme(plot.title = element_text(hjust = 0.5))
```

Not much jumps out in the scatterplots. It is conventional wisdom that high pitch total pitch volumes lead to injuries, but this expected result is either not visible over the course of one season or it's being swamped by other factors. There does seem to be a little bit of clustering of shoulder injuries at high pitch volume (around 3000 pitches in one season), implying that players who throw more pitches are more susceptible to shoulder injuries. 

##Injury Type

As a measure of injury severity, we look at how many days each injury lasted in the data for 2016 and 2017. We use both boxplots and scatterplots. 

```{r}
ggplot(filter(joined, days < 180), aes(x=reorder(type, days, FUN = median), y=days)) +
  geom_boxplot(color="deepskyblue4") + coord_flip() + ylab("Recovery Time (days)") + xlab("Injury Type") +
  ggtitle("Injury Type vs Recovery Time") + theme(plot.title = element_text(hjust = 0.5))

ggplot(filter(joined, days < 180), aes(x=reorder(type, days, FUN = median), y=days)) +
  geom_jitter(color="deepskyblue3") + coord_flip() + ylab("Recovery Time (days)") + xlab("Injury Type") +
  ggtitle("Injury Type vs Recovery Time") + theme(plot.title = element_text(hjust = 0.5))
```
By using median days values, the most severe injuries seem to be elbow Tommy John injuries, bicep injuries, and toe injuries. Elbow Tommy John injuries being the highest on this list makes sense. This kind of injury refers to a special elbow injury that involves a torn UCL, which is an extremely important elbow ligament.  

The median injury length values may be important, but arguably more important is frequency of injuries. The scatterplot indicates that injuries pitching injuries (shoulder, elbow, and arm) are among the most frequent. 

## Types of Pitches And Injuries
Since it seems that pitching injuries are quite frequent, it may be worth exploring pitching injuries in-depth. We look at whether players who throw certain types of pitches are more susceptible to getting injured, and whether certain kinds of pitches lead to specific types on injuries. This has been a holy grail of baseball research and is still hotly debated. While it is unlikely that anything will be settled without modeling, some trends may be visible using exploratory analysis. 

First we filter out every column except the 9 pitch percentage columns and plot the various kinds of injuries vs average pitch type percentage across all players with those injuries:
```{r}
percent_cols <- colnames(joined)[8:16]
# tidy the data so we can facet on pitch types

g <- gather(filter(joined_pitchers), pt, pt_pct, percent_cols)
levels(g$pt) <- percent_cols
g <- arrange(g, pt)

ggplot(g, aes(x = type, y = pt_pct, fill = pt, order = pt)) + geom_bar(stat="summary", position = "dodge") +
  theme(axis.text.x = element_text(angle=30), plot.title = element_text(hjust = 0.5)) + 
  ylab("Number of Pitches") + xlab("Injury Type") + ggtitle("Injury Type vs Number of Pitches") +
  scale_color_discrete() + 
  scale_fill_discrete(name="Pitch Type", labels = c("changeup","curveball","fastball","cutter fastball","split-fingered fastball","2-seam fastball","knuckle-curve", "sinker","slider"))
```
Fastballs dominate too much to clearly see what's happening with the rest of the pitches, so let's filter fastballs out and repeat the analysis:
```{r}
percent_cols_no_FA <- colnames(joined)[9:16]
# tidy the data so we can facet on pitch types
g <- gather(filter(joined_pitchers), pt, pt_pct, percent_cols_no_FA)
levels(g$pt) <- percent_cols_no_FA
g <- arrange(g, pt)

ggplot(g, aes(x = type, y = pt_pct, fill = pt, order = pt, width=0.8)) + geom_bar(stat="summary", position = "dodge") + theme(axis.text.x = element_text(angle=30), plot.title = element_text(hjust = 0.5)) + 
  ylab("Number of Pitches") + xlab("Injury Type") + 
  ggtitle("Injury Type vs Number of Pitches (no fastball)") + scale_color_discrete() + 
  scale_fill_discrete(name="Pitch Type", labels = c("changeup","curveball","cutter fastball","split-fingered fastball","2-seam fastball","knuckle-curve", "sinker","slider"))
```
Now, we see that players with finger injuries, oblique injuries, and hip injuries threw, on average, a higher percentage of two-seam fastballs than other pitches. For players who sustained all other injury types, the average percentage of sliders thrown was highest. 
\newpage


**Part2: How Do Injuries Effect Power?**
Now we will look at how different kinds of injuries affect hitters differently. Presumably some kinds of injuries hurt hitters more than others, and we will look at how different kinds of injuries affect power performance as measured by the aforementioned *SLG*. Because we're interested in the long-term effects of injuries, we're going to be looking at a one year lag, *ignoring* the season in which the player was injured. For each player we look at he season before and seasons after the injury to look for changes. 
First we prep the data:
```{r}
injuries2015 <- read_csv('./data/injuries_2015.csv')
injuries2016 <- read_csv('./data/injuries_2016.csv')

df2014 <- read_csv('./data/batters2014.csv')
df2015 <- read_csv('./data/batters2015.csv')
df2016 <- read_csv('./data/batters2016.csv')
df2017 <- read_csv('./data/batters2017.csv')

df2014$year <- 2014
df2015$year <- 2015
df2016$year <- 2016
df2017$year <- 2017
```
Next we tidy the data for a three-year period and finalize the data into one data frame:
```{r}
process <- function(data, injuries) {
  # we only want players who played in each season, and batted at least 150 times in 2015/2017
  data <- mutate(group_by(data, name), cnt = n())
  first_yr <- min(data$year)
  third_yr <- max(data$year)
  scnd_year <- (first_yr + third_yr) / 2
  data <- filter(data, cnt == 3 & year != scnd_year)
  # tidy till before and after
  data <- mutate(data, occ = if_else(year == first_yr, "before", "after"))
  data <- data %>% select(name, occ, SLG)
  data <- spread(data, occ, SLG)
  # merge the injuries
  data <- merge(data, injuries, by.x = "name", by.y = "name", all.x = T)
  data$type[is.na(data$type)] <- "None"
  data$type <- sapply(data$type, extract_injury)
  data
}

bat1 <- rbind(df2015, df2016, df2017)
bat2 <- rbind(df2014, df2015, df2016)

bat1 <- process(bat1, injuries2016)
bat2 <- process(bat2, injuries2015)

bat <- rbind(bat1, bat2)
bat <- bat [!(bat$type=="None"),]
```
Lastly we use a scatterplot to plot *SLG* the year before injury vs *SLG* the year after injury colored by injury type:
```{r}
ggplot(bat, aes(before, after)) + geom_point(aes(color = type)) + ylab("SLG After") + xlab("SLG Before") + ggtitle("Injury Change in SLG") + theme(plot.title = element_text(hjust = 0.5))
```

Immediately, it is quite difficult to see much of anything, so instead we try a bar chart, plotting the ratios of *SLG* before and *SLG* after injury. 
```{r}
bat <- mutate(bat, chng = before / after)

ggplot(bat) + geom_bar(aes(x = type, y = chng), stat="summary", color="darkolivegreen4", fill="darkolivegreen4") + stat_summary(aes(x = type, y = chng),fun.y = "mean") + 
  coord_flip() + ylab("SLG Change") + xlab("Injury Type") + ggtitle("Injury-Caused Difference in SLG") + 
  theme(plot.title = element_text(hjust = 0.5))
```

Now it's possible to see some patterns emerge. Lower body injuries seem to have the largest effect on power; ACL tears, knee injuries, toe injuries, hip, and calf injuries have the largest decreases in *SLG* the year after injury. This makes intuitive sense, since a large part of hitting involves building power from the lower half into the swing. However, some of the results are non-obvious; for example, it is remarkable that toe injuries have a larger effect on how hard a player
hits the ball than wrist injuries. Of course this analysis uses only four seasons of data, and we'd want to revisit this on larger datasets. Nonetheless the lower body/upper body difference seems strong.  

**Part 3: How Well Do Injuries Predict Future Injuries?**
Our next question involves the extent to which different injuries suggest future susceptibility to more injury. We combine all the injury data into one dataframe, and plot a stacked bar chart to see what percentage of players who sustained an injury got injured again:
```{r}
# process injury data
i1 <- read_csv('./data/injuries_2015.csv')
i2 <- read_csv('./data/injuries_2016.csv')
i3 <- read_csv('./data/injuries_2017.csv')

i1$year = 2015
i2$year = 2016
i3$year = 2017

iAll <- rbind(i1, i2, i3)
iAll <- arrange(iAll, name, year)
iAll <- mutate(group_by(iAll, name), cnt = n())
# data <- mutate(data, occ = if_else(year == first_yr, "before", "after"))
iAll <- iAll %>% mutate(was_followed = if_else(cnt > 1 & year != 2017, 1, 0))
# remove 2017
iAll <- filter(iAll, year != 2017)
iAll$type <- sapply(iAll$type, extract_injury)
iAll <- iAll %>% group_by(type, was_followed) %>%
          summarise(num_i = n()) %>%
          mutate(prop = num_i / sum(num_i))

iAll <- iAll %>% mutate(followed = if_else(was_followed == 0, "No", "Yes"))

ggplot(iAll, aes(x = type, y = prop, fill = followed)) + geom_bar(stat = "identity") + 
  theme(axis.text.x = element_text(angle=90), plot.title = element_text(hjust = 0.5)) + 
  ylab("Proportion Yes/No") + xlab("Injury Type") + ggtitle("Did this injury follow a previous injury?")
```
It seems that certain types on injuries are definitely more predictive of future injuries, but the caveat is that we don't have much data to work with. The numbers are not huge because finding injury data that goes back more than a few years is difficult. With a larger dataset, we could investigate if certain types of injuries could predict specific future injuries, but our slices would be too small for just three years of data.


**Part 4: Did the Ball Change in the Middle of 2015?**

First, let's just establish that home runs *did* increase.

```{r}
## structure the data so that months are orderd included, in the date
hr <- read_csv('./data/homeRuns.csv')
# just make Mar/April April and Sep/Oct September
hr$Month[hr$Month == 'Mar/Apr'] <- 'Apr'
hr$Month[hr$Month == 'Sept/Oct'] <- 'Sep'
hr$Month <- as.factor(hr$Month)
levels(hr$Month) = c("Apr", "May", "Jun", "Jul", "Aug", "Sep")
# zoo parser is much better
hr$Date <- as.yearmon(paste0(hr$Season, hr$Month), "%Y%b")
hr$Date <- as.Date(hr$Date)
```

```{r}
label <- function(d) { format(d, "%b") }

ggplot(hr, aes(x = Month, y = HR, color = as.character(Season), group = as.character(Season))) + 
  theme(plot.title = element_text(hjust = 0.5)) + geom_point() + geom_line() + 
  labs(x = "Month", y = "Number of Home Runs") + ggtitle("Number of Home Runs per Season") +
  scale_color_discrete(name = "Season")
```
So home runs per month are definitely up year over year. (This is necessary because fewer HRS are typically hit in colder weather, and certain months have fewer games and days). The top two lines are
2017 and 2016. Looking at the lines, it certainly looks like HRs spiked above trend after July of 2015. This doesn't tell us anything about the ball, however. A more informative thing to look at
would be *home runs on contact*, since how many strikeouts there are could be influencing the number of home runs. If fewer players are striking out then home runs will naturally go up. We can strip
out all strikeouts to see what would happen if every ball was put into play.

##Home Runs on Contact

```{r}
hr <- hr %>% mutate(onContact =  HR / (1 - `K%`))
ggplot(hr, aes(x = Month, y = onContact, color = as.character(Season), group = as.character(Season))) + 
  theme(plot.title = element_text(hjust = 0.5)) + geom_point() + geom_line() + 
  labs(x = "Month", y = "Home Runs on Contact") + ggtitle("Number of Home Runs on Contact per Season") +
  scale_color_discrete(name = "Season")
```
This looks even starker. The gap between May 2015 and May 2017 looks like it's a little under 300, from a baseline of around 1150; an increase of around 25%! That's an enormous number; if a ball was
put into play in May of 2017, it was 25% more likely to be hit for a home run than it was in 2015. There are of course other explanations - the composition of players isn't the same, ballparks in the league
could have changed, weather pattersn could be changing in specific ways that influence home runs. But there are hundreds of players in the league and compisition changes slowly, and the trend increase
appears to have begun in the middle of a season, when none of the parks had changed. But the factory location was moved in the middle of the 2015 season, and anecdotal comments from players suggest that
the seams are generally slightly lower (though still within the strict range allowed). But even a small decrease in seam height reduces drag on the ball and causes it to carry further. The league insists
it has run tests and nothing has changed, but it would be fun to try to collect a bunch of balls from before and after the location change and see if seam height was any different. 


**Part 5: How Might Robot Umpires Effect The Strike Zone?**



